<div class="container mx-auto p-3 lg:p-4">
  <div class="mb-3">
    <h1 class="text-xl font-bold mb-1">Citation Duplicates</h1>
    <p class="text-sm text-gray-600">
      Review and merge potential duplicate citations in <%= @project.name %>
    </p>
  </div>

  <!-- Comparison Field Selection -->
  <div class="bg-white rounded shadow p-4 mb-3">
    <h2 class="text-base font-semibold mb-2">Comparison Settings</h2>

    <%= form_with url: citation_duplicates_project_path(@project), method: :get, local: true, class: "space-y-3", id: "duplicate-settings-form" do |f| %>
      <div>
        <label class="block text-xs font-medium text-gray-700 mb-1">
          Select fields to compare:
        </label>
        <div class="space-y-1">
          <% CitationDuplicateDetector::COMPARISON_FIELDS.each do |field| %>
            <label class="inline-flex items-center mr-6">
              <%= check_box_tag 'comparison_fields[]', field, @comparison_fields.include?(field), class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" %>
              <span class="ml-2 text-sm text-gray-700"><%= field.humanize %></span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- Fuzzy Matching Controls -->
      <div class="border-t border-gray-200 pt-2">
        <label class="block text-xs font-medium text-gray-700 mb-2">
          Fuzzy Matching (Optional):
        </label>

        <% if @comparison_fields.include?('title') %>
          <div class="mb-2">
            <label class="block text-xs text-gray-700 mb-1">
              Title: <span id="fuzzy-title-value" class="font-medium"><%= @fuzzy_title || 0 %>%</span>
              <span class="text-xs text-gray-500">(0% = exact, 90% = fuzzy)</span>
            </label>
            <input type="range" name="fuzzy_title" min="0" max="100" value="<%= @fuzzy_title || 0 %>"
                   class="w-full h-2" id="fuzzy-title-slider"
                   oninput="document.getElementById('fuzzy-title-value').textContent = this.value + '%'">
          </div>
        <% end %>

        <% if @comparison_fields.include?('authors') %>
          <div class="mb-2">
            <label class="block text-xs text-gray-700 mb-1">
              Authors: <span id="fuzzy-authors-value" class="font-medium"><%= @fuzzy_authors || 0 %>%</span>
              <span class="text-xs text-gray-500">(0% = exact, 85% = fuzzy)</span>
            </label>
            <input type="range" name="fuzzy_authors" min="0" max="100" value="<%= @fuzzy_authors || 0 %>"
                   class="w-full h-2" id="fuzzy-authors-slider"
                   oninput="document.getElementById('fuzzy-authors-value').textContent = this.value + '%'">
          </div>
        <% end %>

        <div class="text-xs text-gray-600 bg-blue-50 p-2 rounded">
          <strong>Note:</strong> Set slider to 0% for exact matching, or 85-95% to catch typos.
        </div>

        <% citation_count = @project.citations_projects.count %>
        <% if citation_count > 1000 %>
          <div class="text-xs text-yellow-700 bg-yellow-50 p-2 rounded border border-yellow-200 mt-2">
            <strong>⚠️</strong> <%= citation_count %> citations - fuzzy matching may take 30-60s.
          </div>
        <% end %>
      </div>

      <div class="pt-2">
        <%= submit_tag "Update Results", class: "inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded shadow-sm text-white bg-blue-600 hover:bg-blue-700" %>
      </div>
    <% end %>
  </div>

  <!-- Duplicate Groups -->
  <% if @duplicate_groups.empty? %>
    <div class="bg-green-50 border border-green-200 rounded p-4 text-center">
      <svg class="mx-auto h-8 w-8 text-green-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-base font-medium text-green-900">No Duplicates Found</h3>
      <p class="text-sm text-green-700">
        No duplicate citations detected with the selected comparison fields.
      </p>
    </div>
  <% else %>
    <%= form_with url: merge_citation_duplicates_project_path(@project), method: :post, local: true, id: "merge-groups-form" do |f| %>
      <div class="bg-white rounded shadow mb-3 p-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">
              Found <span class="font-semibold text-gray-900"><%= @duplicate_groups.size %></span> duplicate groups
              (<span class="font-semibold text-gray-900"><%= @duplicate_groups.sum { |g| g[:count] } %></span> total citations)
            </p>
          </div>
          <div class="flex items-center space-x-3">
            <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
              <input type="checkbox" id="select-all-groups" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2">
              <span>Select All</span>
            </label>
            <%= submit_tag "Merge Selected Groups",
                id: "merge-selected-btn",
                data: { confirm: "This will merge all selected duplicate groups. The oldest citation in each group will be kept as the master. Continue?" },
                class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded shadow-sm text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed",
                disabled: true %>
            <%= link_to "Auto-Merge All", dedupe_citations_project_path(@project),
                method: :post,
                data: { confirm: "This will automatically merge all duplicate citations. The oldest citation record will be kept as the master. Continue?" },
                class: "inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded shadow-sm text-white bg-red-600 hover:bg-red-700" %>
          </div>
        </div>
      </div>

      <!-- Duplicate Group Cards -->
      <div class="space-y-6">
        <% @duplicate_groups.each_with_index do |group, group_index| %>
          <div class="bg-white rounded-lg shadow overflow-hidden" id="group-<%= group_index %>">
            <!-- Group Header -->
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
              <div class="flex items-start justify-between">
                <div class="flex items-start space-x-2">
                  <input type="checkbox"
                         name="group_citation_ids[]"
                         value="<%= group[:citations_projects].map(&:citation_id).join(',') %>"
                         class="group-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                         style="margin-top: 0.35rem;"
                         id="group-<%= group_index %>-checkbox">
                  <label for="group-<%= group_index %>-checkbox" class="cursor-pointer flex-1">
                    <h3 class="text-lg font-medium text-gray-900">
                      Duplicate Group <%= group_index + 1 %>
                      <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <%= group[:count] %> duplicates
                      </span>
                    </h3>
                    <p class="text-sm text-gray-500">
                      Matching: <%= group[:signature].keys.map(&:to_s).map(&:humanize).join(', ') %>
                    </p>
                  </label>
                </div>
              </div>
            </div>

          <!-- Citation Cards -->
          <div class="divide-y divide-gray-200">
            <% group[:citations_projects].each_with_index do |cp, idx| %>
              <div class="p-6 <%= idx == 0 ? 'bg-green-50' : '' %>">
                <div class="flex items-start">
                  <div class="flex-shrink-0">
                    <% if idx == 0 %>
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                        Master (Oldest)
                      </span>
                    <% else %>
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        Duplicate
                      </span>
                    <% end %>
                  </div>

                  <div class="ml-4 flex-1">
                    <div class="flex items-center justify-between">
                      <div class="text-sm font-medium text-gray-900">
                        Citation ID: <%= cp.citation_id %>
                        <span class="ml-2 text-gray-500">(Created: <%= cp.citation.created_at.strftime('%Y-%m-%d') %>)</span>
                      </div>
                      <%= link_to "View", citation_path(cp.citation, project_id: @project.id),
                          target: "_blank",
                          class: "text-sm text-blue-600 hover:text-blue-800" %>
                    </div>

                    <div class="mt-3 space-y-2">
                      <% if @comparison_fields.include?('title') %>
                        <div>
                          <span class="text-xs font-medium text-gray-500 uppercase">Title:</span>
                          <p class="text-sm text-gray-900"><%= cp.citation.name || '(none)' %></p>
                        </div>
                      <% end %>

                      <% if @comparison_fields.include?('authors') %>
                        <div>
                          <span class="text-xs font-medium text-gray-500 uppercase">Authors:</span>
                          <p class="text-sm text-gray-900"><%= cp.citation.authors || '(none)' %></p>
                        </div>
                      <% end %>

                      <% if @comparison_fields.include?('accession_number') %>
                        <div>
                          <span class="text-xs font-medium text-gray-500 uppercase">Accession Number:</span>
                          <p class="text-sm text-gray-900">
                            <%= cp.citation.pmid || cp.citation.refman || '(none)' %>
                          </p>
                        </div>
                      <% end %>

                      <% if @comparison_fields.include?('publication_year') %>
                        <div>
                          <span class="text-xs font-medium text-gray-500 uppercase">Year:</span>
                          <p class="text-sm text-gray-900">
                            <%
                              year = if cp.citation.journal&.publication_date
                                pub_date = cp.citation.journal.publication_date
                                if pub_date.respond_to?(:year)
                                  pub_date.year
                                else
                                  parsed = Date.parse(pub_date.to_s) rescue nil
                                  parsed&.year
                                end
                              end
                            %>
                            <%= year || '(none)' %>
                          </p>
                        </div>
                      <% end %>

                      <!-- Association counts -->
                      <div class="mt-3 pt-3 border-t border-gray-200">
                        <span class="text-xs font-medium text-gray-500 uppercase">Associations:</span>
                        <div class="mt-1 flex space-x-4 text-sm text-gray-700">
                          <span><%= cp.extractions.count %> extractions</span>
                          <span><%= cp.abstract_screening_results.count %> abstract screenings</span>
                          <span><%= cp.fulltext_screening_results.count %> fulltext screenings</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    <% end %>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('select-all-groups');
  const groupCheckboxes = document.querySelectorAll('.group-checkbox');
  const mergeButton = document.getElementById('merge-selected-btn');

  // Update merge button state based on selected checkboxes
  function updateMergeButton() {
    const anyChecked = Array.from(groupCheckboxes).some(cb => cb.checked);
    mergeButton.disabled = !anyChecked;
  }

  // Select/deselect all groups
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      groupCheckboxes.forEach(cb => {
        cb.checked = this.checked;
      });
      updateMergeButton();
    });
  }

  // Update select-all checkbox and merge button when individual checkboxes change
  groupCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Update select-all checkbox state
      const allChecked = Array.from(groupCheckboxes).every(cb => cb.checked);
      const noneChecked = Array.from(groupCheckboxes).every(cb => !cb.checked);

      if (selectAllCheckbox) {
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
      }

      updateMergeButton();
    });
  });
});
</script>
