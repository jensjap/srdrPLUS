<div x-data="sdMetaDatum" class="p-4 lg:p-8 space-y-2">
  <div class="font-bold text-sm">
    <div class="flex justify-between">
      <div>
        SRDR+ Project: <%= link_to(@project.try(:name) || 'None',
        project_path(@project), target: '_blank') %>
      </div>

      <div class="flex justify-center items-center text-xs">
        Complete
        <button
          type="button"
          class="ml-2 group relative inline-flex h-5 w-10 flex-shrink-0 cursor-pointer items-center justify-center rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
          role="switch"
          aria-checked="false"
          @click="enabled = !enabled"
        >
          <span class="sr-only">Use setting</span>
          <span
            aria-hidden="true"
            class="pointer-events-none absolute h-full w-full rounded-md bg-white"
          ></span>
          <span
            aria-hidden="true"
            class="pointer-events-none absolute mx-auto h-4 w-9 rounded-full transition-colors duration-200 ease-in-out"
            :class="enabled ? 'bg-indigo-600' : 'bg-gray-200'"
          ></span>
          <span
            aria-hidden="true"
            class="pointer-events-none absolute left-0 inline-block h-5 w-5 transform rounded-full border border-gray-200 bg-white shadow ring-0 transition-transform duration-200 ease-in-out"
            :class="enabled ? 'translate-x-5' : 'translate-x-0'"
          ></span>
        </button>
      </div>
    </div>
    <div class="flex justify-between">
      <div>
        <% if @systematic_review_report %> Source Systematic Review Report:
        <a data-toggle="offCanvasRightReportHtml" id="report-title">
          <!-- prettier-ignore -->
          <%= @sd_meta_datum.try(:report_title) || @report.try(:title) || @sd_meta_datum.report_file.filename || 'None' %>
        </a>
        <% end %>
      </div>
      <div
        class="bg-srdrpurple text-white text-xs p-1 rounded-md cursor-pointer"
      >
        See Section Preview
      </div>
    </div>
    <div class="w-full bg-gray-200 rounded-full p-1 my-1">
      <div
        class="bg-green-600 p-1 text-white rounded-full text-center"
        style="width: 50%"
      ></div>
    </div>
  </div>
  <div class="flex w-full">
    <div class="border text-sm font-bold w-3/12 xl:w-1/12">
      <a href="/sd_meta_data/307/edit?panel_number=0&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 0 ? 'bg-purple-100' : ''"
        >
          Title, Funding Sources, and Dates
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=1&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 1 ? 'bg-purple-100' : ''"
        >
          Authors and Stakeholders
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=2&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 2 ? 'bg-purple-100' : ''"
        >
          URL Links
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=3&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 3 ? 'bg-purple-100' : ''"
        >
          Purpose, Analytic Framework, and Key Questions
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=4&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 4 ? 'bg-purple-100' : ''"
        >
          PICODTS
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=5&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 5 ? 'bg-purple-100' : ''"
        >
          Key Question Mapping
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=6&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 6 ? 'bg-purple-100' : ''"
        >
          Search Strategy and Results of Screening
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=7&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 7 ? 'bg-purple-100' : ''"
        >
          Risk of Bias and Overall Summary of Evidence
        </div>
      </a>
      <a href="/sd_meta_data/307/edit?panel_number=8&new_template=true">
        <div
          class="p-1 py-4 cursor-pointer border-b-2"
          :class="panel_number == 8 ? 'bg-purple-100' : ''"
        >
          Results for Individual Outcomes
        </div>
      </a>
    </div>
    <%= render "sd_meta_data/form/#{params[:panel_number]}" %>
  </div>
</div>

<script>
  document.addEventListener("alpine:init", () => {
    Alpine.data("sdMetaDatum", () => ({
      sdMetaDatum: {},
      enabled: true,
      panel_number: null,

      async init() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const panel_number = urlParams.get("panel_number");
        this.panel_number = panel_number;

        const id = /\d+/.exec(window.location.pathname);
        await this.getSdMetaDatum(id);
        this.initSelect2();
      },

      async initSelect2() {
        $("#funding_sources").select2({
          ajax: {
            url: "/funding_sources",
            dataType: "json",
            selectOnClose: true,
            allowClear: true,
            data: (params) => {
              var query = {
                q: params.term,
                page: params.page,
              };
              return query;
            },
            processResults: (data, params) => {
              params.page = params.page || 1;
              return {
                results: $.map(data.items, (i) => {
                  return {
                    id: i.id,
                    text: i.name,
                  };
                }),
              };
            },
          },
        });
      },

      async getSdMetaDatum(id) {
        const response = await fetch(`/sd_meta_data/${id}/edit`, {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
        });
        const sdMetaDatum = await response.json();
        this.sdMetaDatum = sdMetaDatum;
      },
    }));
  });
</script>
