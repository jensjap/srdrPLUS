script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"

- if @groups.empty?
  div No questions found. Please make another selection.
  = link_to('Go Back', project_report_links_path)
- else
  #export-to-gdrive-url.div.hide
    = export_to_gdrive_project_url @project.id

  div#project-ids.grid-x.grid-padding-x data-key-question-project-ids="#{@key_question_project_ids}"
    div.cell.small-12
      div.button.start-query style="float: right; margin-left: 10px;" Start Query
      div.button.alert.remove-last-column style="float: right; margin-left: 10px;" Remove Last Column
      div.button.success.add-column style="float: right; margin-left: 10px;" Add Column
      fieldset
        input#column-name autofocus="" style="float: right; margin: 10px; padding-left: 5px; width: 300px;" placeholder="Column Name"
  div.grid-x.grid-padding-x
    div.cell.small-3 style="padding-top: 10px; border: 0.4px solid; max-height: 500px; overflow-y: scroll;"
      input#field-search placeholder="Search for fields" style="width: 100%;"
      - @groups.each do |section, items|
        ul.vertical.menu.accordion-menu data-accordion-menu=''
          li
            a.field-option-header ondragstart="return false;" href="#" #{section.name}
            ul.menu.vertical.nested style="margin: 0;"
              li.field-option-parent
                - items.each do |question|
                  div.query-pill.query-draggable.right data-tooltip='' title="#{question.description.present? ? question.description : "No Description" }" id="kq-#{question.id}" data-type="Type2" data-item-id="#{question.id}" draggable="true" #{ question.name }
      ul.vertical.menu.accordion-menu data-accordion-menu=''
        li
          a.field-option-header ondragstart="return false;" href="#" Results
          - @results_groups.each do |section, items|
            ul.vertical.menu.accordion-menu data-accordion-menu=''
              li
                a.field-option-header ondragstart="return false;" href="#" #{section.name}
                ul.menu.vertical.nested style="margin: 0;"
                  li.field-option-parent
                    - items.each do |rssm|
                      div.query-pill.query-draggable id="rssm-#{rssm.id}" data-type="#{section.type_name}" data-item-id="#{rssm.id}" draggable="true" #{ rssm.measure.name }
    div.cell.small-9 style="padding-top: 10px; border: 0.4px solid; overflow-x: auto;"
      div#columns.column-sortable
        div.field-column style="width: 300px;"
          span class="grippy" draggable="true"
          h5.field-option-column-title Sample Column
          div.droppable.sortable

javascript:
  $.event.props.push('dataTransfer');

  function checkForDuplicate(parentNode, candidateNode) {
    var existingIds = [];
    $(parentNode).children().each(function() {
      existingIds.push(this.getAttribute('data-item-id'));
    })
    var candidateNodeId = candidateNode.getAttribute('data-item-id');
    return existingIds.includes(candidateNodeId.toString());
  }

  function addColumn() {
    $('.noselect').remove();
    var columnName = $('#column-name').val();
    if (columnName === '') {
      $('#column-name').focus().select();
      return;
    }

    $('#columns').append(`<div class="field-column" style="width: 300px;"><span class="grippy" draggable="true"></span><h5 class='field-option-column-title'>${columnName}</h5><div class="droppable sortable"></div></div>`);
    $('#column-name').val('');
    makeSortable();
  }

  function removeLastColumn() {
    $('#columns > div:last-child').remove();
  }

  function extractReportQuestions() {
    var mapping = [];

    $('.droppable').each(function() {
      var currentEl = $(this);
      var column_name = currentEl.closest('.field-column').children('h5').text();
      var sectionMap = {
        column_name,
        export_ids: [],
        type: ''
      };
      currentEl.children().each (function() {
        var questionId = $(this).data('item-id');
        var type = $(this).data('type');
        sectionMap.export_ids.push(questionId);
        sectionMap.type = type;
      })
      mapping.push(sectionMap);
    });
    var keyQuestionProjectIds = $('#project-ids').
      data('key-question-project-ids').
      split(",").
      slice(1).
      map(function(string) { return Number(string) })

    return { payload: mapping, kqs_ids: keyQuestionProjectIds };
  }

  function searchFields(searchString) {
    $('.field-option-parent').children().each(function() {
      var currentElement = $(this);

      var fieldName = currentElement.text().toLowerCase();
      if (searchString === '') {
        currentElement.removeClass('hide')
      } else if (fieldName.includes(searchString)) {
        currentElement.removeClass('hide')
      } else {
        currentElement.addClass('hide')
      }
    })
    countFieldChildren();
  }

  function countFieldChildren() {
    $('.field-option-header').each(function() {
      var currentHeaderElement = $(this);
      var currentChildCount = 0;
      var currentHeaderText = currentHeaderElement.text().split(" - ")[0];

      currentHeaderElement.siblings('ul').find('li > div').each(function() {
        var currentOptionElement = $(this);
        if (!currentOptionElement.hasClass('hide')) {
          currentChildCount += 1;
        }
      })

      currentHeaderElement.text(`${currentHeaderText} - ${currentChildCount}`)
    })
  }

  function colorFieldOptions() {
    $('.query-draggable').each(function() {
      var currentElement = $(this);
      var type = currentElement.data('type');

      if (type === 'Type2') {
        currentElement.css({ 'background-color': '#006aaa' });
      } else if (type === 'Descriptive') {
        currentElement.css({ 'background-color': '#cc4b37' });
      } else if (type === 'BAC') {
        currentElement.css({ 'background-color': '#4c0d7d' });
      } else if (type === 'WAC') {
        currentElement.css({ 'background-color': '#c4a300' });
      } else if (type === 'NET') {
        currentElement.css({ 'background-color': '#4c4c4c' });
      }
    })
  }

  function makeSortable() {
    $('.sortable').sortable({ connectWith: ".sortable" });
    $('.column-sortable').sortable();
  }

  $(document).on('dragstart', '.query-draggable', function(ev) {
    ev.dataTransfer.setData("text/plain", ev.target.id);
  })

  $(document).on('dragleave', '.droppable', function(ev) {
    ev.preventDefault();
    ev.currentTarget.style.background = "aliceblue";
  })

  $(document).on('dragover', '.droppable', function(ev) {
    ev.stopPropagation();
    ev.preventDefault();

    if (ev.target.getAttribute("draggable") == "true") {
      ev.dataTransfer.dropEffect = "none";
    } else {
      ev.currentTarget.style.background = "lightblue";
      ev.dataTransfer.dropEffect = "copy";
    }
  })

  $(document).on('drop', '.droppable', function(ev) {
    ev.preventDefault();
    ev.currentTarget.style.background = "aliceblue";
    var data = ev.dataTransfer.getData("text/plain");
    var originalNode = document.getElementById(data);

    //if (checkForDuplicate(ev.target, originalNode)) return;

    var nodeCopy = originalNode.cloneNode(true);
    nodeCopy.id = new Date().getTime();
    $(nodeCopy).text(`${$(nodeCopy).text()} - (click to remove)`)
    $(nodeCopy).addClass('clickremove');
    ev.target.appendChild(nodeCopy);
  })

  $(document).on('click', '.clickremove', function(ev) {
    ev.target.remove();
  })

  $('#column-name').on("keyup", function(e) {
    if (e.keyCode === 13) { addColumn(); }
  });

  $('#field-search').on("keyup", function(e) {
    searchFields(e.target.value.toLowerCase());
  });

  $(document).on('click', '.add-column', function() {
    addColumn();
  })

  $(document).on('click', '.remove-last-column', function() {
    removeLastColumn();
  })

  $(document).on('click', '.start-query', function() {
    $.post($('#export-to-gdrive-url').text(), extractReportQuestions());
  })

  $(document).on('click', '.field-option-column-title', function() {
    var title = $(this).text();
    var newInput = $(`<input class="column-title-input" value="${title}">`);
    $(this).text('');
    $(this).append(newInput);
    newInput.focus();
  })

  $(document).on('click', '.column-title-input', function(ev) {
    ev.stopPropagation();
  })

  $(document).on('focusout', '.column-title-input', function() {
    var title = $(this).val();
    if (title === '') title = 'No Title';
    $(this).parent().parent().children('h5').text(title);
    $(this).remove();
  })

  $(document).on('keypress', '.column-title-input', function(ev) {
    if (ev.charCode === 13) {
      $(ev.currentTarget).blur();
    }
  })

  $(document).ready(function() {
    colorFieldOptions();
    countFieldChildren();
    makeSortable();
  });
